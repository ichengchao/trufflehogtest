name: TruffleHog Secrets Scan
on: [push]
jobs:
  TruffleHog:
    runs-on: ubuntu-latest
    container:
      image: trufflesecurity/trufflehog:latest
    steps:
      - uses: actions/checkout@v3
      - name: scan code
        id: myscan
        continue-on-error: true
        run: |
          mystring="${{ github.workspace }}"
          echo ${mystring:18}
          rm -rf /__w/${mystring:18}/.git
          trufflehog filesystem /__w/${mystring:18} --no-verification --no-update > /tmp/myscan.txt
      - name: send msg
        id: sendmsg
        if: ${{steps.mystep.outcome == 'failure'}}
        run: |
          MYRESULT=`cat /tmp/myscan.txt`
          echo "--------------------------------------------------------"
          echo $MYRESULT
          echo "scan_result=`cat /tmp/myscan.txt`" >> $GITHUB_OUTPUT
          echo "--------------------------------------------------------"
          echo "${{steps.sendmsg.outputs.scan_result}}"
          echo "--------------------------------------------------------"
          apk --no-cache add curl
          curl --location --request POST 'https://oapi.dingtalk.com/robot/send?access_token=${{ secrets.dingding_access_token }}' \
          --header 'Content-Type: application/json' \
          --data-raw '{
              "msgtype": "markdown",
              "markdown": {
                  "title": "TruffleHog Bingo",
                  "text": "### TruffleHog Bingo â˜ž AK \n\n-----------------   \n\n **repository:** ${{ github.repository }} \n\n **message:** ${{ github.event.head_commit.message }}  \n\n **author:** ${{ github.actor }} \n\n ${{steps.sendmsg.outputs.scan_result}}"
              }
          }'
